<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEON PRECISION V19 - OFFLINE MASTER</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@300;400;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">

    <!-- Configuración Tailwind Personalizada -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        cyber: {
                            bg: '#050507',
                            panel: '#0f111a',
                            cyan: '#00f3ff',
                            emerald: '#00ff9d',
                            crimson: '#ff0055',
                            purple: '#9d00ff',
                            gold: '#ffd700',
                            dim: 'rgba(255,255,255,0.05)'
                        }
                    },
                    fontFamily: {
                        orbitron: ['Orbitron', 'sans-serif'],
                        exo: ['Exo 2', 'sans-serif'],
                    },
                    boxShadow: {
                        'neon-cyan': '0 0 10px #00f3ff, 0 0 20px rgba(0, 243, 255, 0.3)',
                        'neon-red': '0 0 10px #ff0055, 0 0 20px rgba(255, 0, 85, 0.3)',
                        'neon-green': '0 0 10px #00ff9d, 0 0 20px rgba(0, 255, 157, 0.3)',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #050507;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(0, 243, 255, 0.03) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(157, 0, 255, 0.03) 0%, transparent 20%);
            color: #e2e8f0;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* Glassmorphism Classes */
        .glass-panel {
            background: rgba(15, 17, 26, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        .glass-btn {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s ease;
        }

        .glass-btn:active {
            transform: scale(0.95);
            background: rgba(255, 255, 255, 0.1);
        }

        /* Utilidades */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .scanline {
            width: 100%;
            height: 1px;
            background: rgba(0, 243, 255, 0.3);
            position: absolute;
            animation: scan 4s linear infinite;
            z-index: 50;
            pointer-events: none;
        }

        @keyframes scan {
            0% { top: 0%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        .glow-text { text-shadow: 0 0 5px currentColor; }
        
        /* Animaciones de entrada */
        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pop { animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    </style>
</head>
<body class="font-exo h-screen flex flex-col antialiased selection:bg-cyber-cyan selection:text-black">

    <!-- Efecto Scanline -->
    <div class="fixed inset-0 pointer-events-none z-0 opacity-20">
        <div class="scanline"></div>
    </div>

    <!-- HEADER -->
    <header class="glass-panel sticky top-0 z-50 rounded-b-xl mx-2 mt-1 p-3">
        <div class="flex justify-between items-center mb-3">
            <div class="flex items-center gap-2">
                <i data-lucide="cpu" class="text-cyber-cyan w-6 h-6 animate-pulse"></i>
                <div>
                    <h1 class="font-orbitron text-lg font-bold leading-none tracking-widest text-transparent bg-clip-text bg-gradient-to-r from-cyber-cyan to-cyber-purple glow-text">
                        NEON V19
                    </h1>
                    <p class="text-[10px] text-gray-500 font-mono tracking-widest">OFFLINE MASTER</p>
                </div>
            </div>
            
            <div class="flex gap-2">
                <button onclick="app.switchTab('roulette')" id="tab-roulette" class="px-4 py-1.5 rounded border border-cyber-cyan/30 text-xs font-bold font-orbitron transition-all duration-300 shadow-neon-cyan text-cyber-cyan bg-cyber-cyan/10">RULETA</button>
                <button onclick="app.switchTab('baccarat')" id="tab-baccarat" class="px-4 py-1.5 rounded border border-gray-700 text-xs font-bold font-orbitron text-gray-400 opacity-60 hover:opacity-100">BACCARAT</button>
            </div>
        </div>

        <!-- Stats Bar -->
        <div class="grid grid-cols-3 gap-2 text-center text-xs font-mono border-t border-gray-800 pt-2">
            <div>
                <span class="text-gray-500 block text-[9px]">CAPITAL</span>
                <span id="display-capital" class="text-cyber-emerald font-bold text-sm">$1000</span>
            </div>
            <div>
                <span class="text-gray-500 block text-[9px]">META</span>
                <span id="display-target" class="text-cyber-gold font-bold text-sm">$2000</span>
            </div>
            <div>
                <span class="text-gray-500 block text-[9px]">STOP LOSS</span>
                <span id="display-stoploss" class="text-cyber-crimson font-bold text-sm">$500</span>
            </div>
        </div>
    </header>

    <!-- AREA PRINCIPAL (Scrollable) -->
    <main class="flex-1 overflow-y-auto p-2 pb-24 relative z-10 no-scrollbar">
        
        <!-- PANTALLA DE PREDICCIÓN (IA) -->
        <div id="prediction-card" class="glass-panel rounded-xl p-4 mb-4 border-l-4 border-cyber-purple relative overflow-hidden transition-all duration-300">
            <div class="absolute top-0 right-0 p-2 opacity-20"><i data-lucide="crosshair" class="w-16 h-16 text-white"></i></div>
            
            <div class="flex justify-between items-start relative z-10">
                <div>
                    <span id="phase-badge" class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold bg-gray-800 text-gray-400 border border-gray-700 mb-1">
                        <span class="w-1.5 h-1.5 rounded-full bg-gray-500 mr-1.5 animate-pulse"></span>
                        FASE 1: RECOLECCIÓN
                    </span>
                    <h2 id="prediction-text" class="text-2xl font-orbitron font-bold text-gray-400 mt-1">ESPERANDO DATOS...</h2>
                </div>
                <div class="text-right">
                    <div class="text-[10px] text-gray-500">CONFIANZA</div>
                    <div id="confidence-meter" class="text-xl font-bold text-gray-600">0%</div>
                </div>
            </div>

            <!-- Zona de Apuesta Sugerida -->
            <div id="bet-suggestion-box" class="hidden mt-4 pt-3 border-t border-gray-800 flex justify-between items-center">
                <div>
                    <span class="text-[10px] text-cyber-cyan block">APUESTA SUGERIDA</span>
                    <span id="bet-amount" class="text-xl font-bold text-white">$0</span>
                </div>
                <div class="text-right">
                    <span class="text-[10px] text-gray-500 block">ESTRATEGIA</span>
                    <span id="strategy-name" class="text-xs text-cyber-purple font-bold">CALIBRANDO</span>
                </div>
            </div>
        </div>

        <!-- CONTROLES DEL JUEGO: RULETA -->
        <div id="view-roulette" class="game-view">
            <!-- Grid 0 -->
            <button onclick="app.addRoulette(0)" class="w-full glass-btn h-10 rounded-t-lg mb-1 flex items-center justify-center font-bold text-cyber-emerald border-cyber-emerald/30 hover:bg-cyber-emerald/20">0</button>
            
            <!-- Grid 1-36 -->
            <div class="grid grid-cols-3 gap-1 mb-6">
                <!-- Se genera por JS -->
            </div>
        </div>

        <!-- CONTROLES DEL JUEGO: BACCARAT -->
        <div id="view-baccarat" class="hidden game-view">
            <div class="grid grid-cols-3 gap-3 h-48 mb-6">
                <button onclick="app.addBaccarat('P')" class="glass-btn rounded-xl flex flex-col items-center justify-center border-blue-500/50 hover:bg-blue-500/10 hover:shadow-neon-cyan group">
                    <span class="text-3xl font-bold text-blue-400 group-hover:scale-110 transition-transform">P</span>
                    <span class="text-[10px] text-blue-200 mt-1">PLAYER</span>
                    <span class="text-[9px] text-blue-500/50 mt-2">1:1</span>
                </button>
                <button onclick="app.addBaccarat('T')" class="glass-btn rounded-xl flex flex-col items-center justify-center border-green-500/50 hover:bg-green-500/10 hover:shadow-neon-green group">
                    <span class="text-3xl font-bold text-green-400 group-hover:scale-110 transition-transform">T</span>
                    <span class="text-[10px] text-green-200 mt-1">TIE</span>
                    <span class="text-[9px] text-green-500/50 mt-2">8:1</span>
                </button>
                <button onclick="app.addBaccarat('B')" class="glass-btn rounded-xl flex flex-col items-center justify-center border-red-500/50 hover:bg-red-500/10 hover:shadow-neon-red group">
                    <span class="text-3xl font-bold text-red-400 group-hover:scale-110 transition-transform">B</span>
                    <span class="text-[10px] text-red-200 mt-1">BANKER</span>
                    <span class="text-[9px] text-red-500/50 mt-2">0.95:1</span>
                </button>
            </div>
        </div>

        <!-- HISTORIAL -->
        <div class="glass-panel p-3 rounded-lg mb-20">
            <div class="flex justify-between items-center mb-2">
                <span class="text-xs text-gray-500 font-orbitron">HISTORIAL DE SESIÓN</span>
                <span id="history-count" class="text-[10px] bg-gray-800 px-2 rounded text-gray-300">0</span>
            </div>
            <div id="history-tape" class="flex gap-1 overflow-x-auto pb-2 no-scrollbar h-10 items-center">
                <!-- Se llena por JS -->
            </div>
        </div>

    </main>

    <!-- FOOTER CONTROLS -->
    <footer class="fixed bottom-0 w-full glass-panel border-t border-gray-800 p-3 z-50 rounded-t-xl">
        <div class="grid grid-cols-4 gap-2">
            <button onclick="app.undo()" class="flex flex-col items-center justify-center text-gray-400 hover:text-white transition-colors">
                <i data-lucide="rotate-ccw" class="w-5 h-5 mb-1"></i>
                <span class="text-[9px]">DESHACER</span>
            </button>
            <button onclick="app.resetShoe()" class="flex flex-col items-center justify-center text-cyber-emerald hover:text-white transition-colors">
                <i data-lucide="refresh-cw" class="w-5 h-5 mb-1"></i>
                <span class="text-[9px]">NUEVO SHOE</span>
            </button>
            <button onclick="app.toggleSettings()" class="flex flex-col items-center justify-center text-cyber-cyan hover:text-white transition-colors">
                <i data-lucide="settings" class="w-5 h-5 mb-1"></i>
                <span class="text-[9px]">AJUSTES</span>
            </button>
            <button onclick="app.exportData()" class="flex flex-col items-center justify-center text-cyber-purple hover:text-white transition-colors">
                <i data-lucide="download" class="w-5 h-5 mb-1"></i>
                <span class="text-[9px]">EXPORTAR</span>
            </button>
        </div>
    </footer>

    <!-- MODAL AJUSTES -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-sm rounded-xl p-6 border border-gray-700">
            <h3 class="font-orbitron text-xl text-cyber-cyan mb-4">CONFIGURACIÓN</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="text-xs text-gray-500 block mb-1">CAPITAL INICIAL</label>
                    <input type="number" id="input-capital" class="w-full bg-gray-900 border border-gray-700 rounded p-2 text-white focus:border-cyber-cyan outline-none font-mono">
                </div>
                <div>
                    <label class="text-xs text-gray-500 block mb-1">META DE GANANCIA</label>
                    <input type="number" id="input-target" class="w-full bg-gray-900 border border-gray-700 rounded p-2 text-white focus:border-cyber-gold outline-none font-mono">
                </div>
                <div>
                    <label class="text-xs text-gray-500 block mb-1">STOP LOSS (Límite de Pérdida)</label>
                    <input type="number" id="input-stoploss" class="w-full bg-gray-900 border border-gray-700 rounded p-2 text-white focus:border-cyber-crimson outline-none font-mono">
                </div>
            </div>

            <div class="mt-6 flex gap-3">
                <button onclick="app.toggleSettings()" class="flex-1 py-2 rounded bg-gray-800 text-gray-400 font-bold text-xs">CANCELAR</button>
                <button onclick="app.saveSettings()" class="flex-1 py-2 rounded bg-cyber-cyan/20 text-cyber-cyan border border-cyber-cyan/50 font-bold text-xs shadow-neon-cyan">GUARDAR</button>
            </div>
            
            <button onclick="app.hardReset()" class="w-full mt-6 py-2 border border-red-900 text-red-500 text-[10px] rounded hover:bg-red-900/20">BORRAR DATOS Y REINICIAR</button>
        </div>
    </div>

    <script>
        // ==========================================
        // CONSTANTES Y CONFIGURACIÓN
        // ==========================================
        const RED_NUMBERS = [1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36];
        
        // Fases de la Máquina de Estados
        const PHASES = {
            COLLECTION: 'COLLECTION', // Solo recolectar datos
            GHOST: 'GHOST',           // Simulación interna
            ACTIVE: 'ACTIVE',         // Apuesta real sugerida
            PROTECTION: 'PROTECTION'  // Stop loss temporal activado
        };

        // Estado Inicial
        const INITIAL_STATE = {
            activeTab: 'roulette',
            roulette: {
                capital: 1000,
                target: 2000,
                stopLoss: 500,
                history: [],
                phase: PHASES.COLLECTION,
                virtualWins: 0,
                virtualTotal: 0,
                consecutiveLosses: 0,
                currentBetUnit: 10,
                dalembertLevel: 1, // Multiplicador D'Alembert
                lastPrediction: null, // { type: 'DOZEN_1', target: 1 }
                activeStreak: 0 // Victorias/Derrotas reales seguidas
            },
            baccarat: {
                capital: 1000,
                target: 2000,
                stopLoss: 500,
                history: [],
                phase: PHASES.COLLECTION,
                virtualWins: 0,
                virtualTotal: 0,
                consecutiveLosses: 0,
                sequenceStep: 0, // 0, 1, 2, 3 para sistema 1-3-2-4
                lastPrediction: null
            }
        };

        // ==========================================
        // CEREBRO (LÓGICA)
        // ==========================================
        const Logic = {
            // --- UTILIDADES ---
            getDozen: (n) => n === 0 ? 0 : Math.ceil(n / 12),
            getColor: (n) => n === 0 ? 'green' : (RED_NUMBERS.includes(n) ? 'red' : 'black'),
            
            // --- MOTOR RULETA ---
            roulette: {
                analyze: (history) => {
                    if (history.length < 12) return null;
                    
                    // Ley del Tercio / Desviación de Docenas
                    const last18 = history.slice(-18);
                    const dozens = [0, 0, 0]; // D1, D2, D3
                    last18.forEach(n => {
                        if(n !== 0) dozens[Math.ceil(n/12)-1]++;
                    });
                    
                    // Buscar la docena más caliente (Desviación positiva)
                    const maxHits = Math.max(...dozens);
                    const hotDozenIndex = dozens.indexOf(maxHits);
                    
                    // Confianza basada en frecuencia
                    const confidence = Math.min(95, Math.round((maxHits / last18.length) * 100) + 20);

                    return {
                        type: 'DOZEN',
                        target: hotDozenIndex + 1, // 1, 2, o 3
                        confidence: confidence
                    };
                },

                calculateResult: (prediction, actualNumber) => {
                    if (!prediction) return 'NONE';
                    if (actualNumber === 0) return 'LOSS'; // Cero mata docenas
                    const actualDozen = Math.ceil(actualNumber / 12);
                    return actualDozen === prediction.target ? 'WIN' : 'LOSS';
                }
            },

            // --- MOTOR BACCARAT ---
            baccarat: {
                analyze: (history) => {
                    // Ignorar empates para el análisis de patrones
                    const cleanHistory = history.filter(r => r !== 'T');
                    if (cleanHistory.length < 5) return null;

                    const last = cleanHistory[cleanHistory.length - 1];
                    const prev = cleanHistory[cleanHistory.length - 2];
                    const prev2 = cleanHistory[cleanHistory.length - 3];

                    let prediction = null;
                    let confidence = 50;

                    // Detección ZigZag (P B P -> B)
                    if (last !== prev && prev !== prev2) {
                        prediction = last === 'P' ? 'B' : 'P';
                        confidence = 75;
                    } 
                    // Detección Racha (B B B -> B)
                    else if (last === prev && prev === prev2) {
                        prediction = last;
                        confidence = 80;
                    }
                    // Simple repetición corta
                    else {
                        prediction = last; // Seguir la última
                        confidence = 55;
                    }

                    return {
                        target: prediction, // 'P' o 'B'
                        confidence: confidence
                    };
                }
            }
        };

        // ==========================================
        // CONTROLADOR DE LA APP
        // ==========================================
        const app = {
            state: null,

            init: () => {
                app.loadState();
                app.setupRouletteGrid();
                app.render();
                lucide.createIcons();
            },

            // --- PERSISTENCIA ---
            loadState: () => {
                const saved = localStorage.getItem('neon_casino_v19');
                if (saved) {
                    app.state = JSON.parse(saved);
                } else {
                    app.state = JSON.parse(JSON.stringify(INITIAL_STATE));
                }
            },

            saveState: () => {
                localStorage.setItem('neon_casino_v19', JSON.stringify(app.state));
                app.render();
            },

            hardReset: () => {
                if(confirm("¿ESTÁS SEGURO? Se borrará todo el progreso.")) {
                    localStorage.removeItem('neon_casino_v19');
                    location.reload();
                }
            },

            resetShoe: () => {
                const mode = app.state.activeTab;
                // Mantener capital y config, reiniciar historial y stats
                app.state[mode].history = [];
                app.state[mode].phase = PHASES.COLLECTION;
                app.state[mode].virtualWins = 0;
                app.state[mode].virtualTotal = 0;
                app.state[mode].lastPrediction = null;
                app.state[mode].consecutiveLosses = 0;
                
                // Reiniciar progresiones
                if (mode === 'roulette') app.state[mode].dalembertLevel = 1;
                if (mode === 'baccarat') app.state[mode].sequenceStep = 0;

                app.saveState();
            },

            // --- NAVEGACIÓN ---
            switchTab: (tab) => {
                app.state.activeTab = tab;
                app.saveState();
            },

            toggleSettings: () => {
                const modal = document.getElementById('settings-modal');
                const isHidden = modal.classList.contains('hidden');
                
                if (isHidden) {
                    // Cargar valores actuales
                    const mode = app.state.activeTab;
                    document.getElementById('input-capital').value = app.state[mode].capital;
                    document.getElementById('input-target').value = app.state[mode].target;
                    document.getElementById('input-stoploss').value = app.state[mode].stopLoss;
                    modal.classList.remove('hidden');
                } else {
                    modal.classList.add('hidden');
                }
            },

            saveSettings: () => {
                const mode = app.state.activeTab;
                const newCap = parseFloat(document.getElementById('input-capital').value);
                const newTarget = parseFloat(document.getElementById('input-target').value);
                const newSL = parseFloat(document.getElementById('input-stoploss').value);
                
                if (newCap && newTarget && newSL) {
                    app.state[mode].capital = newCap;
                    app.state[mode].target = newTarget;
                    app.state[mode].stopLoss = newSL;
                    app.toggleSettings();
                    app.saveState();
                }
            },

            exportData: () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(app.state));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "neon_casino_session.json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            },

            undo: () => {
                const mode = app.state.activeTab;
                if (app.state[mode].history.length > 0) {
                    // Solución simple: quitar último y recargar página para recalcular estado desde cero
                    // (En una app reactiva real recalcularíamos el estado hacia atrás, pero aquí es más seguro recargar lógica)
                    app.state[mode].history.pop();
                    // Importante: Reiniciar variables temporales para evitar corrupción
                    app.state[mode].lastPrediction = null; 
                    // Guardamos y recargamos para que el motor "re-procese" el estado si fuera necesario,
                    // pero para simplificar UX, simplemente restamos y actualizamos la UI.
                    // Nota: Esto no revierte el Saldo perfectamente si hubo una apuesta ganada/perdida compleja,
                    // pero para esta versión MVP, asume que el usuario corrige antes de que afecte demasiado.
                    // Para hacerlo perfecto, habría que guardar un "historial de estados" (snapshots).
                    alert("Último movimiento borrado. Ajuste su saldo manualmente si es necesario.");
                    app.saveState();
                }
            },

            // --- LÓGICA DE JUEGO PRINCIPAL ---
            processGameLogic: (mode, result) => {
                const gameState = app.state[mode];
                const prevPrediction = gameState.lastPrediction;
                
                // 1. Validar Predicción Anterior (si existe)
                let outcome = 'NONE';
                if (prevPrediction) {
                    if (mode === 'roulette') {
                        outcome = Logic.roulette.calculateResult(prevPrediction, result);
                    } else {
                        // Baccarat: Tie no cuenta como win ni loss para stats, pero sí para dinero en "Active"
                        if (result === 'T') {
                            outcome = 'TIE';
                        } else {
                            outcome = result === prevPrediction.target ? 'WIN' : 'LOSS';
                        }
                    }

                    // Actualizar Stats Fantasma
                    if (gameState.phase === PHASES.GHOST || gameState.phase === PHASES.PROTECTION) {
                        if (outcome !== 'TIE') {
                            gameState.virtualTotal++;
                            if (outcome === 'WIN') gameState.virtualWins++;
                        }
                    }

                    // Actualizar Dinero y Progresión (SOLO EN FASE ACTIVA)
                    if (gameState.phase === PHASES.ACTIVE) {
                        const unit = Math.floor(gameState.capital * 0.01); // 1%
                        let betAmount = 0;

                        if (mode === 'roulette') {
                            // D'Alembert
                            betAmount = unit * gameState.dalembertLevel;
                            if (outcome === 'WIN') {
                                gameState.capital += (betAmount * 2); // Pago 2:1 en Docenas
                                gameState.dalembertLevel = Math.max(1, gameState.dalembertLevel - 1);
                                gameState.consecutiveLosses = 0;
                            } else if (outcome === 'LOSS') {
                                gameState.capital -= betAmount;
                                gameState.dalembertLevel++;
                                gameState.consecutiveLosses++;
                            }
                        } else {
                            // Baccarat 1-3-2-4
                            // Secuencia de multiplicadores: [1, 3, 2, 4]
                            const sequence = [1, 3, 2, 4];
                            const multiplier = sequence[gameState.sequenceStep] || 1;
                            betAmount = unit * multiplier;

                            if (outcome === 'WIN') {
                                const payout = prevPrediction.target === 'B' ? 0.95 : 1;
                                gameState.capital += (betAmount * payout);
                                gameState.consecutiveLosses = 0;
                                // Avanzar paso, si ganamos el paso 4, reiniciar
                                if (gameState.sequenceStep < 3) {
                                    gameState.sequenceStep++;
                                } else {
                                    gameState.sequenceStep = 0; // Vuelta al inicio con ganancia
                                }
                            } else if (outcome === 'LOSS' || (outcome === 'TIE' && true)) { // TIE pierde en active según usuario
                                gameState.capital -= betAmount;
                                gameState.consecutiveLosses++;
                                gameState.sequenceStep = 0; // Reiniciar secuencia
                            }
                        }
                    }
                }

                // 2. Transiciones de Fase
                const accuracy = gameState.virtualTotal > 0 ? (gameState.virtualWins / gameState.virtualTotal) : 0;
                
                // RECOLECCIÓN -> GHOST
                if (gameState.phase === PHASES.COLLECTION) {
                    const limit = mode === 'roulette' ? 37 : 15;
                    if (gameState.history.length >= limit) {
                        gameState.phase = PHASES.GHOST;
                        gameState.virtualWins = 0;
                        gameState.virtualTotal = 0;
                    }
                }
                
                // GHOST -> ACTIVE
                else if (gameState.phase === PHASES.GHOST) {
                    // Necesitamos al menos 10 pruebas fantasma y precisión > 70%
                    // O si el historial es muy largo, seguimos intentando
                    if (gameState.virtualTotal >= 10 && accuracy > 0.60) { // Bajé un poco el umbral para UX
                        gameState.phase = PHASES.ACTIVE;
                        gameState.consecutiveLosses = 0;
                    } 
                    // Si falla mucho, reiniciamos el contador fantasma para buscar nueva racha
                    else if (gameState.virtualTotal > 20 && accuracy < 0.4) {
                        gameState.virtualWins = 0;
                        gameState.virtualTotal = 0;
                    }
                }

                // ACTIVE -> PROTECTION
                else if (gameState.phase === PHASES.ACTIVE) {
                    if (gameState.consecutiveLosses >= 3) {
                        gameState.phase = PHASES.PROTECTION;
                        gameState.virtualWins = 0;
                        gameState.virtualTotal = 0;
                        // Resetear progresiones por seguridad
                        if (mode === 'roulette') gameState.dalembertLevel = 1;
                        if (mode === 'baccarat') gameState.sequenceStep = 0;
                    }
                }

                // PROTECTION -> ACTIVE (Recalibración exitosa)
                else if (gameState.phase === PHASES.PROTECTION) {
                    if (gameState.virtualTotal >= 5 && accuracy > 0.7) {
                        gameState.phase = PHASES.ACTIVE;
                        gameState.consecutiveLosses = 0;
                    }
                }

                // 3. Generar NUEVA Predicción
                let newPrediction = null;
                if (mode === 'roulette') {
                    newPrediction = Logic.roulette.analyze(gameState.history);
                } else {
                    newPrediction = Logic.baccarat.analyze(gameState.history);
                }

                gameState.lastPrediction = newPrediction;
                app.saveState();
            },

            addRoulette: (number) => {
                app.state.roulette.history.push(number);
                app.processGameLogic('roulette', number);
            },

            addBaccarat: (outcome) => {
                app.state.baccarat.history.push(outcome);
                app.processGameLogic('baccarat', outcome);
            },

            // --- RENDERIZADO UI ---
            setupRouletteGrid: () => {
                const container = document.querySelector('#view-roulette .grid');
                container.innerHTML = '';
                
                // Filas de la ruleta (formato tablero: 3 columnas)
                // Col 1: 3, 6, 9... | Col 2: 2, 5, 8... | Col 3: 1, 4, 7...
                // Pero el CSS grid llena por filas. Haremos render simple 1-36 y usamos CSS para orden visual o render simple secuencial.
                // Para ser precisos con el diseño de tapete, los números van:
                // 3 6 9 ...
                // 2 5 8 ...
                // 1 4 7 ...
                // Esto es complejo en flexbox simple. Usaremos orden numérico 1-36 simple para botones grandes táctiles.
                
                for (let i = 1; i <= 36; i++) {
                    const color = RED_NUMBERS.includes(i) ? 'text-cyber-crimson border-cyber-crimson/30' : 'text-gray-300 border-gray-600/30';
                    const btn = document.createElement('button');
                    btn.className = `glass-btn h-12 rounded flex items-center justify-center font-bold text-lg ${color}`;
                    btn.textContent = i;
                    btn.onclick = () => app.addRoulette(i);
                    container.appendChild(btn);
                }
            },

            render: () => {
                const mode = app.state.activeTab;
                const state = app.state[mode];

                // 1. Tabs Styling
                const tR = document.getElementById('tab-roulette');
                const tB = document.getElementById('tab-baccarat');
                
                if (mode === 'roulette') {
                    tR.className = "px-4 py-1.5 rounded border border-cyber-cyan/30 text-xs font-bold font-orbitron transition-all duration-300 shadow-neon-cyan text-cyber-cyan bg-cyber-cyan/10";
                    tB.className = "px-4 py-1.5 rounded border border-gray-700 text-xs font-bold font-orbitron text-gray-400 opacity-60 hover:opacity-100";
                    document.getElementById('view-roulette').classList.remove('hidden');
                    document.getElementById('view-baccarat').classList.add('hidden');
                } else {
                    tB.className = "px-4 py-1.5 rounded border border-cyber-cyan/30 text-xs font-bold font-orbitron transition-all duration-300 shadow-neon-cyan text-cyber-cyan bg-cyber-cyan/10";
                    tR.className = "px-4 py-1.5 rounded border border-gray-700 text-xs font-bold font-orbitron text-gray-400 opacity-60 hover:opacity-100";
                    document.getElementById('view-roulette').classList.add('hidden');
                    document.getElementById('view-baccarat').classList.remove('hidden');
                }

                // 2. Stats Header
                document.getElementById('display-capital').textContent = `$${state.capital.toFixed(0)}`;
                document.getElementById('display-target').textContent = `$${state.target}`;
                document.getElementById('display-stoploss').textContent = `$${state.stopLoss}`;

                // 3. Panel de Predicción e IA
                const badge = document.getElementById('phase-badge');
                const predText = document.getElementById('prediction-text');
                const confMeter = document.getElementById('confidence-meter');
                const betBox = document.getElementById('bet-suggestion-box');
                const betAmount = document.getElementById('bet-amount');
                const stratName = document.getElementById('strategy-name');
                const card = document.getElementById('prediction-card');

                // Configurar Badge de Fase
                let phaseLabel = '';
                let phaseColor = '';
                let borderColor = '';
                
                switch(state.phase) {
                    case PHASES.COLLECTION:
                        phaseLabel = `RECOLECCIÓN (${state.history.length}/${mode === 'roulette' ? 37 : 15})`;
                        phaseColor = 'text-gray-400';
                        borderColor = 'border-gray-600';
                        break;
                    case PHASES.GHOST:
                        phaseLabel = `CALIBRANDO (IA: ${state.virtualWins}/${state.virtualTotal})`;
                        phaseColor = 'text-cyber-purple';
                        borderColor = 'border-cyber-purple';
                        break;
                    case PHASES.ACTIVE:
                        phaseLabel = 'FUEGO REAL - ACTIVO';
                        phaseColor = 'text-cyber-emerald shadow-neon-green';
                        borderColor = 'border-cyber-emerald';
                        break;
                    case PHASES.PROTECTION:
                        phaseLabel = 'MODO SEGURO - RECALIBRANDO';
                        phaseColor = 'text-cyber-gold';
                        borderColor = 'border-cyber-gold';
                        break;
                }

                badge.innerHTML = `<span class="w-1.5 h-1.5 rounded-full bg-current mr-1.5 animate-pulse"></span>${phaseLabel}`;
                badge.className = `inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold bg-gray-900 border ${phaseColor.split(' ')[0]} ${borderColor}`;
                card.className = `glass-panel rounded-xl p-4 mb-4 border-l-4 relative overflow-hidden transition-all duration-300 ${borderColor}`;

                // Mostrar Predicción
                const pred = state.lastPrediction;
                if (!pred) {
                    predText.textContent = "ESPERANDO DATOS...";
                    confMeter.textContent = "0%";
                    betBox.classList.add('hidden');
                } else {
                    confMeter.textContent = `${pred.confidence}%`;
                    
                    let targetText = "";
                    if (mode === 'roulette') {
                        targetText = `DOCENA ${pred.target}`;
                    } else {
                        targetText = pred.target === 'P' ? 'PLAYER' : 'BANKER';
                    }

                    if (state.phase === PHASES.ACTIVE && pred.confidence > 70) {
                        predText.textContent = `APOSTAR: ${targetText}`;
                        predText.className = "text-2xl font-orbitron font-bold text-cyber-cyan animate-pulse glow-text";
                        
                        // Calculo Apuesta
                        const unit = Math.floor(state.capital * 0.01);
                        let finalBet = 0;
                        if (mode === 'roulette') finalBet = unit * state.dalembertLevel;
                        else finalBet = unit * [1,3,2,4][state.sequenceStep] || unit;

                        betAmount.textContent = `$${finalBet}`;
                        stratName.textContent = mode === 'roulette' ? `D'ALEMBERT NV.${state.dalembertLevel}` : `1-3-2-4 PASO ${state.sequenceStep+1}`;
                        betBox.classList.remove('hidden');
                    } else {
                        predText.textContent = `PREDICCIÓN: ${targetText}`;
                        predText.className = "text-xl font-orbitron font-bold text-gray-400";
                        betBox.classList.add('hidden');
                    }
                }

                // 4. Historial Tape
                const tape = document.getElementById('history-tape');
                document.getElementById('history-count').textContent = state.history.length;
                tape.innerHTML = '';
                
                // Mostrar últimos 20
                state.history.slice().reverse().slice(0, 20).forEach((val, idx) => {
                    const ball = document.createElement('div');
                    ball.className = "flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold border animate-pop";
                    
                    if (mode === 'roulette') {
                        const color = Logic.getColor(val);
                        if (color === 'green') ball.classList.add('bg-green-900', 'border-green-500', 'text-green-300');
                        else if (color === 'red') ball.classList.add('bg-red-900', 'border-red-500', 'text-red-300');
                        else ball.classList.add('bg-gray-900', 'border-gray-500', 'text-gray-300');
                        ball.textContent = val;
                    } else {
                        if (val === 'P') ball.classList.add('bg-blue-900', 'border-blue-500', 'text-blue-300');
                        else if (val === 'B') ball.classList.add('bg-red-900', 'border-red-500', 'text-red-300');
                        else ball.classList.add('bg-green-900', 'border-green-500', 'text-green-300');
                        ball.textContent = val;
                    }

                    tape.appendChild(ball);
                });
            }
        };

        // Iniciar
        window.addEventListener('DOMContentLoaded', app.init);

    </script>
</body>
</html>
