<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEON ROULETTE MASTER</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --neon-cyan: #0ff0fc;
            --neon-green: #00ff9d;
            --dark-bg: #0a0a0f;
            --darker-bg: #050508;
            --card-bg: #11111a;
        }
        
        body {
            background-color: var(--dark-bg);
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
        }
        
        .neon-cyan {
            color: var(--neon-cyan);
            text-shadow: 0 0 10px var(--neon-cyan);
        }
        
        .neon-green {
            color: var(--neon-green);
            text-shadow: 0 0 10px rgba(0, 255, 157, 0.5);
        }
        
        .neon-border {
            border: 2px solid var(--neon-cyan);
            box-shadow: 0 0 15px rgba(0, 240, 252, 0.3);
        }
        
        .neon-glow {
            box-shadow: 0 0 20px rgba(0, 240, 252, 0.5);
        }
        
        .chip-shadow {
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.7));
        }
        
        .phase-1 { border-left: 5px solid #ff6b6b; }
        .phase-2 { border-left: 5px solid #ffd93d; }
        .phase-3 { border-left: 5px solid #6bcf7f; }
        .phase-4 { border-left: 5px solid #ff8e6b; }
        
        .red-roulette { background-color: #d32f2f; }
        .black-roulette { background-color: #212121; }
        .green-roulette { background-color: #2e7d32; }
        
        .red-roulette:hover { background-color: #f44336; }
        .black-roulette:hover { background-color: #424242; }
        .green-roulette:hover { background-color: #4caf50; }
        
        .history-item {
            transition: all 0.3s ease;
        }
        
        .history-item:hover {
            transform: scale(1.05);
        }
        
        .progress-bar {
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
            background-color: #333;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--neon-cyan), var(--neon-green));
            transition: width 0.5s ease;
        }
        
        .phase-badge {
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .chip {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            color: black;
            margin: 3px;
            transition: transform 0.2s;
        }
        
        .chip:hover {
            transform: scale(1.1);
        }
        
        .chip-500 { background-color: #ff9800; }
        .chip-2500 { background-color: #2196f3; }
        .chip-5000 { background-color: #4caf50; }
        .chip-25000 { background-color: #9c27b0; }
        .chip-100000 { background-color: #f44336; }
        .chip-500000 { background-color: #ffeb3b; color: #333; }
        .chip-1200000 { background-color: #00bcd4; }
        .chip-5000000 { background-color: #795548; }
        
        @media (max-width: 640px) {
            .chip {
                width: 40px;
                height: 40px;
                font-size: 12px;
            }
        }
        
        /* Animaciones */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 240, 252, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 240, 252, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 240, 252, 0); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
    </style>
</head>
<body class="min-h-screen p-4">
    <div class="max-w-6xl mx-auto">
        <!-- Encabezado -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold neon-cyan mb-2">NEON ROULETTE MASTER</h1>
            <p class="text-lg text-gray-300 mb-4">Sistema de predicción matemática para ruleta europea</p>
            
            <div class="flex flex-wrap justify-center gap-4 mb-6">
                <div class="bg-gray-900 rounded-lg p-3 neon-border">
                    <div class="text-sm text-gray-400">Fase Actual</div>
                    <div id="currentPhase" class="text-xl font-bold neon-green">Fase 1: Recolección</div>
                </div>
                
                <div class="bg-gray-900 rounded-lg p-3 neon-border">
                    <div class="text-sm text-gray-400">Saldo</div>
                    <div id="currentBalance" class="text-xl font-bold">$10,000</div>
                </div>
                
                <div class="bg-gray-900 rounded-lg p-3 neon-border">
                    <div class="text-sm text-gray-400">Precisión</div>
                    <div id="accuracy" class="text-xl font-bold">0%</div>
                </div>
            </div>
        </header>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Panel izquierdo: Control y Fichas -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Panel de Control -->
                <div class="bg-gray-900 rounded-xl p-5 neon-border fade-in">
                    <h2 class="text-2xl font-bold neon-cyan mb-4 flex items-center">
                        <i class="fas fa-sliders-h mr-2"></i> Panel de Control
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-300 mb-2">Capital Inicial ($)</label>
                            <input type="number" id="initialCapital" value="10000" min="100" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500">
                        </div>
                        
                        <div>
                            <label class="block text-gray-300 mb-2">Meta de Ganancia ($)</label>
                            <input type="number" id="profitTarget" value="15000" min="100" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500">
                        </div>
                        
                        <div>
                            <label class="block text-gray-300 mb-2">Stop Loss ($)</label>
                            <input type="number" id="stopLoss" value="5000" min="100" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500">
                        </div>
                        
                        <div>
                            <label class="block text-gray-300 mb-2">Progreso hacia la Meta</label>
                            <div class="progress-bar mt-2">
                                <div id="progressFill" class="progress-fill" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between text-sm text-gray-400 mt-1">
                                <span id="currentProgress">$10,000</span>
                                <span id="targetProgress">$15,000</span>
                            </div>
                        </div>
                        
                        <button id="updateSettings" class="w-full bg-gradient-to-r from-cyan-600 to-green-600 hover:from-cyan-700 hover:to-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 transform hover:scale-105">
                            <i class="fas fa-sync-alt mr-2"></i> Actualizar Configuración
                        </button>
                    </div>
                </div>
                
                <!-- Fichas Inteligentes -->
                <div class="bg-gray-900 rounded-xl p-5 neon-border fade-in">
                    <h2 class="text-2xl font-bold neon-green mb-4 flex items-center">
                        <i class="fas fa-coins mr-2"></i> Fichas Inteligentes
                    </h2>
                    
                    <div class="mb-4">
                        <div class="text-gray-300 mb-2">Apuesta Calculada:</div>
                        <div id="currentBet" class="text-3xl font-bold neon-cyan text-center">$0</div>
                    </div>
                    
                    <div class="text-gray-300 mb-3">Composición de fichas:</div>
                    <div id="chipComposition" class="flex flex-wrap justify-center gap-2 mb-6">
                        <!-- Las fichas se generarán dinámicamente -->
                        <div class="text-gray-500 text-center py-4">Ingresa números para calcular la apuesta</div>
                    </div>
                    
                    <div class="text-gray-300 mb-3">Valores de fichas disponibles:</div>
                    <div class="flex flex-wrap justify-center gap-2">
                        <div class="chip chip-500">500</div>
                        <div class="chip chip-2500">2.5K</div>
                        <div class="chip chip-5000">5K</div>
                        <div class="chip chip-25000">25K</div>
                        <div class="chip chip-100000">100K</div>
                        <div class="chip chip-500000">500K</div>
                        <div class="chip chip-1200000">1.2M</div>
                        <div class="chip chip-5000000">5M</div>
                    </div>
                </div>
                
                <!-- Controles -->
                <div class="bg-gray-900 rounded-xl p-5 neon-border fade-in">
                    <h2 class="text-2xl font-bold neon-cyan mb-4 flex items-center">
                        <i class="fas fa-cogs mr-2"></i> Controles
                    </h2>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <button id="changeDealer" class="bg-gray-800 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 flex flex-col items-center justify-center">
                            <i class="fas fa-user-secret text-2xl mb-2"></i>
                            <span>Cambiar Crupier</span>
                        </button>
                        
                        <button id="undoLast" class="bg-gray-800 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 flex flex-col items-center justify-center">
                            <i class="fas fa-undo text-2xl mb-2"></i>
                            <span>Deshacer</span>
                        </button>
                        
                        <button id="exportData" class="col-span-2 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center">
                            <i class="fas fa-file-export mr-2"></i>
                            <span>Exportar Datos (JSON)</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Panel central: Teclado y Predicciones -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Predicción Actual -->
                <div class="bg-gray-900 rounded-xl p-5 neon-border fade-in">
                    <h2 class="text-2xl font-bold neon-green mb-4 flex items-center">
                        <i class="fas fa-brain mr-2"></i> Predicción del Sistema
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gray-800 rounded-lg p-4">
                            <div class="text-gray-400 mb-2">Docena Predicha:</div>
                            <div id="predictedDozen" class="text-4xl font-bold neon-cyan text-center py-4">-</div>
                            <div class="text-gray-400 text-sm text-center">(Basado en análisis de tendencias)</div>
                        </div>
                        
                        <div class="bg-gray-800 rounded-lg p-4">
                            <div class="text-gray-400 mb-2">Números Recomendados:</div>
                            <div id="recommendedNumbers" class="text-xl font-bold text-center py-4 text-green-400">Esperando datos...</div>
                            <div class="text-gray-400 text-sm text-center">Mejores opciones según el algoritmo</div>
                        </div>
                    </div>
                    
                    <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-gray-800 rounded-lg p-4">
                            <div class="text-gray-400 mb-1">Docena Caliente</div>
                            <div id="hotDozen" class="text-2xl font-bold text-yellow-400">-</div>
                            <div class="text-gray-500 text-xs">Más frecuente</div>
                        </div>
                        
                        <div class="bg-gray-800 rounded-lg p-4">
                            <div class="text-gray-400 mb-1">Docena Fría</div>
                            <div id="coldDozen" class="text-2xl font-bold text-blue-400">-</div>
                            <div class="text-gray-500 text-xs">Menos frecuente</div>
                        </div>
                        
                        <div class="bg-gray-800 rounded-lg p-4">
                            <div class="text-gray-400 mb-1">Último Acierto</div>
                            <div id="lastHit" class="text-2xl font-bold text-green-400">-</div>
                            <div class="text-gray-500 text-xs">Hace X tiros</div>
                        </div>
                    </div>
                    
                    <div class="mt-6 p-4 bg-gray-800 rounded-lg" id="phaseMessage">
                        <div class="flex items-center">
                            <i class="fas fa-info-circle text-cyan-400 mr-3 text-xl"></i>
                            <div>
                                <div class="font-bold neon-cyan">Fase 1: Recolección de Datos</div>
                                <div class="text-gray-300">Por favor, ingresa los primeros 37 números para calibrar el sistema.</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Teclado Numérico -->
                <div class="bg-gray-900 rounded-xl p-5 neon-border fade-in">
                    <h2 class="text-2xl font-bold neon-cyan mb-4 flex items-center">
                        <i class="fas fa-keyboard mr-2"></i> Teclado de Ruleta
                    </h2>
                    
                    <div class="mb-6 text-center">
                        <div class="text-gray-300 mb-2">Números ingresados: <span id="numbersEnteredCount">0</span>/37 (Fase 1)</div>
                        <div class="progress-bar mx-auto max-w-md">
                            <div id="numbersProgress" class="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-4 sm:grid-cols-7 md:grid-cols-8 lg:grid-cols-9 gap-3">
                        <!-- Los botones del 0 al 36 se generarán dinámicamente -->
                    </div>
                    
                    <div class="mt-6 flex justify-center gap-4">
                        <button id="clearAll" class="bg-red-800 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300">
                            <i class="fas fa-trash-alt mr-2"></i> Limpiar Todo
                        </button>
                        
                        <button id="simulateRandom" class="bg-blue-800 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300">
                            <i class="fas fa-dice mr-2"></i> Simular Aleatorio
                        </button>
                    </div>
                </div>
                
                <!-- Historial -->
                <div class="bg-gray-900 rounded-xl p-5 neon-border fade-in">
                    <h2 class="text-2xl font-bold neon-green mb-4 flex items-center">
                        <i class="fas fa-history mr-2"></i> Historial de Tiradas
                    </h2>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="text-gray-400 border-b border-gray-800">
                                    <th class="py-2 text-left">#</th>
                                    <th class="py-2 text-left">Número</th>
                                    <th class="py-2 text-left">Color</th>
                                    <th class="py-2 text-left">Docena</th>
                                    <th class="py-2 text-left">Predicción</th>
                                    <th class="py-2 text-left">Resultado</th>
                                    <th class="py-2 text-left">Apuesta</th>
                                    <th class="py-2 text-left">Saldo</th>
                                </tr>
                            </thead>
                            <tbody id="historyBody">
                                <!-- Las filas se generarán dinámicamente -->
                                <tr>
                                    <td colspan="8" class="text-center py-8 text-gray-500">No hay historial aún. Ingresa números para comenzar.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-4 flex justify-between text-sm text-gray-400">
                        <div>Total tiradas: <span id="totalSpins">0</span></div>
                        <div>Aciertos: <span id="totalHits">0</span> (<span id="hitPercentage">0</span>%)</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <footer class="mt-10 text-center text-gray-500 text-sm border-t border-gray-800 pt-6">
            <p class="neon-cyan font-bold">NEON ROULETTE MASTER V1 - Sistema de Predicción Matemática</p>
            <p class="mt-2">Algoritmo basado en la Ley del Tercio y gestión D'Alembert • Solo para fines educativos</p>
            <p class="mt-2">© 2023 - Todos los derechos reservados</p>
        </footer>
    </div>

    <script>
        // ============================================
        // ESTADO DE LA APLICACIÓN
        // ============================================
        const state = {
            phase: 1, // 1: Recolección, 2: Calibración, 3: Fuego Real, 4: Protección
            balance: 10000,
            initialBalance: 10000,
            profitTarget: 15000,
            stopLoss: 5000,
            currentBet: 0,
            betLevel: 1,
            numbers: [],
            history: [],
            predictions: [],
            testPhaseCount: 0,
            testHits: 0,
            consecutiveLosses: 0,
            dozenStats: {
                1: {count: 0, lastSeen: 0},
                2: {count: 0, lastSeen: 0},
                3: {count: 0, lastSeen: 0}
            },
            unitSize: 0,
            currentDozenPrediction: null
        };

        // Valores de fichas disponibles
        const chipValues = [500, 2500, 5000, 25000, 100000, 500000, 1200000, 5000000];

        // Colores de la ruleta (0 es verde, otros según reglas europeas)
        const rouletteColors = {
            0: 'green',
            32: 'red', 19: 'red', 21: 'red', 25: 'red', 34: 'red', 27: 'red', 36: 'red', 30: 'red', 23: 'red', 5: 'red', 16: 'red', 1: 'red', 14: 'red', 9: 'red', 18: 'red', 7: 'red', 12: 'red', 3: 'red',
            15: 'black', 4: 'black', 2: 'black', 17: 'black', 6: 'black', 13: 'black', 11: 'black', 8: 'black', 10: 'black', 24: 'black', 33: 'black', 20: 'black', 31: 'black', 22: 'black', 29: 'black', 28: 'black', 35: 'black', 26: 'black'
        };

        // Mapeo de números a docenas
        const numberToDozen = (number) => {
            if (number === 0) return 0; // El cero no pertenece a ninguna docena
            return Math.ceil(number / 12);
        };

        // ============================================
        // INICIALIZACIÓN
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            loadState();
            initializeKeyboard();
            updateUI();
            setupEventListeners();
        });

        // Cargar estado desde localStorage
        function loadState() {
            const savedState = localStorage.getItem('neonRouletteState');
            if (savedState) {
                const parsed = JSON.parse(savedState);
                Object.assign(state, parsed);
                console.log('Estado cargado desde localStorage');
            }
        }

        // Guardar estado en localStorage
        function saveState() {
            localStorage.setItem('neonRouletteState', JSON.stringify(state));
        }

        // Inicializar teclado numérico
        function initializeKeyboard() {
            const keyboard = document.querySelector('.grid.gap-3');
            keyboard.innerHTML = '';
            
            // Botón para el 0 (verde)
            createNumberButton(0, keyboard);
            
            // Botones para los números 1-36
            for (let i = 1; i <= 36; i++) {
                createNumberButton(i, keyboard);
            }
        }

        // Crear botón para número
        function createNumberButton(number, container) {
            const button = document.createElement('button');
            button.className = `py-4 rounded-lg font-bold text-xl transition duration-300 transform hover:scale-105 ${getNumberColorClass(number)}`;
            button.textContent = number;
            button.dataset.number = number;
            
            button.addEventListener('click', () => {
                addNumber(number);
            });
            
            container.appendChild(button);
        }

        // Obtener clase CSS para el color del número
        function getNumberColorClass(number) {
            const color = rouletteColors[number] || 'black';
            return `${color}-roulette`;
        }

        // Configurar event listeners
        function setupEventListeners() {
            // Actualizar configuración
            document.getElementById('updateSettings').addEventListener('click', updateSettings);
            
            // Cambiar crupier
            document.getElementById('changeDealer').addEventListener('click', changeDealer);
            
            // Deshacer última jugada
            document.getElementById('undoLast').addEventListener('click', undoLast);
            
            // Exportar datos
            document.getElementById('exportData').addEventListener('click', exportData);
            
            // Limpiar todo
            document.getElementById('clearAll').addEventListener('click', clearAll);
            
            // Simular aleatorio
            document.getElementById('simulateRandom').addEventListener('click', simulateRandom);
        }

        // ============================================
        // LÓGICA DE NEGOCIO
        // ============================================

        // Añadir número al historial
        function addNumber(number) {
            // Registrar número
            state.numbers.push(number);
            
            // Actualizar estadísticas de docenas
            const dozen = numberToDozen(number);
            if (dozen > 0) {
                state.dozenStats[dozen].count++;
                state.dozenStats[dozen].lastSeen = state.numbers.length;
            }
            
            // Determinar docena fría y caliente
            updateDozenStats();
            
            // Calcular predicción según fase
            let prediction = null;
            let hit = false;
            
            if (state.phase === 1) {
                // Fase 1: Solo recolección
                if (state.numbers.length >= 37) {
                    state.phase = 2;
                    state.testPhaseCount = 0;
                    state.testHits = 0;
                }
            } else if (state.phase === 2) {
                // Fase 2: Calibración (Ghost Mode)
                state.testPhaseCount++;
                prediction = predictDozen();
                
                // Verificar si acertó
                const predictedDozen = prediction;
                const actualDozen = numberToDozen(number);
                hit = (predictedDozen === actualDozen && actualDozen !== 0);
                
                if (hit) state.testHits++;
                
                // Evaluar si pasa a fase 3
                if (state.testPhaseCount >= 10) {
                    const accuracy = (state.testHits / state.testPhaseCount) * 100;
                    if (accuracy >= 75) {
                        state.phase = 3; // Pasar a fase activa
                        state.consecutiveLosses = 0;
                        state.betLevel = 1;
                        updatePhaseMessage("¡Sistema calibrado! Precisión del " + accuracy.toFixed(1) + "%. Pasando a FASE 3: FUEGO REAL.");
                    } else {
                        updatePhaseMessage("Precisión insuficiente (" + accuracy.toFixed(1) + "%). Continuando en FASE 2: CALIBRACIÓN.");
                    }
                }
            } else if (state.phase === 3 || state.phase === 4) {
                // Fase 3 y 4: Modo activo con apuestas reales
                prediction = predictDozen();
                
                // Verificar si acertó
                const predictedDozen = prediction;
                const actualDozen = numberToDozen(number);
                hit = (predictedDozen === actualDozen && actualDozen !== 0);
                
                // Calcular apuesta
                calculateBet();
                
                // Actualizar saldo
                if (hit) {
                    // Ganar: apostar a una docena paga 2:1
                    const winAmount = state.currentBet * 2;
                    state.balance += winAmount;
                    state.consecutiveLosses = 0;
                    state.betLevel = Math.max(1, state.betLevel - 1); // D'Alembert: bajar 1 unidad
                } else {
                    // Perder
                    state.balance -= state.currentBet;
                    state.consecutiveLosses++;
                    
                    // El cero no afecta la progresión D'Alembert
                    if (number !== 0) {
                        state.betLevel++; // D'Alembert: subir 1 unidad
                    }
                    
                    // Verificar si pasa a fase de protección
                    if (state.consecutiveLosses >= 3) {
                        state.phase = 4;
                        updatePhaseMessage("¡3 pérdidas consecutivas! Activando FASE 4: PROTECCIÓN. Volviendo a calibración.");
                    }
                }
                
                // Verificar stop loss y profit target
                if (state.balance <= state.stopLoss) {
                    updatePhaseMessage("¡STOP LOSS alcanzado! Reiniciando sistema.");
                    resetToPhase1();
                } else if (state.balance >= state.profitTarget) {
                    updatePhaseMessage("¡META DE GANANCIA alcanzada! ¡FELICIDADES!");
                }
                
                // Si está en fase 4 y acertó, volver a fase 3
                if (state.phase === 4 && hit) {
                    state.phase = 3;
                    state.consecutiveLosses = 0;
                    updatePhaseMessage("¡Acierto en fase de protección! Volviendo a FASE 3: FUEGO REAL.");
                }
            }
            
            // Registrar en historial
            const historyEntry = {
                number,
                color: rouletteColors[number],
                dozen: numberToDozen(number),
                prediction: state.currentDozenPrediction,
                hit,
                bet: state.currentBet,
                balance: state.balance,
                phase: state.phase,
                timestamp: new Date().toLocaleTimeString()
            };
            
            state.history.unshift(historyEntry);
            
            // Guardar estado y actualizar UI
            saveState();
            updateUI();
        }

        // Predecir docena basado en estadísticas
        function predictDozen() {
            // Encontrar docena más fría (mayor retraso)
            let coldestDozen = 1;
            let maxLastSeen = state.dozenStats[1].lastSeen;
            
            for (let i = 2; i <= 3; i++) {
                if (state.dozenStats[i].lastSeen > maxLastSeen) {
                    maxLastSeen = state.dozenStats[i].lastSeen;
                    coldestDozen = i;
                }
            }
            
            // La estrategia apuesta a que la docena más fría aparecerá pronto
            state.currentDozenPrediction = coldestDozen;
            return coldestDozen;
        }

        // Actualizar estadísticas de docenas
        function updateDozenStats() {
            // Actualizar retraso para cada docena
            const currentSpin = state.numbers.length;
            
            for (let dozen = 1; dozen <= 3; dozen++) {
                // Contar cuántas veces ha aparecido esta docena
                let count = 0;
                for (let i = Math.max(0, state.numbers.length - 37); i < state.numbers.length; i++) {
                    if (numberToDozen(state.numbers[i]) === dozen) {
                        count++;
                    }
                }
                state.dozenStats[dozen].count = count;
                
                // Encontrar la última vez que apareció
                let lastSeen = 0;
                for (let i = state.numbers.length - 1; i >= 0; i--) {
                    if (numberToDozen(state.numbers[i]) === dozen) {
                        lastSeen = state.numbers.length - i;
                        break;
                    }
                }
                state.dozenStats[dozen].lastSeen = lastSeen || currentSpin;
            }
        }

        // Calcular apuesta según D'Alembert
        function calculateBet() {
            // Tamaño de unidad: 1% del capital actual
            state.unitSize = state.balance * 0.01;
            
            // Apuesta = nivel de apuesta * tamaño de unidad
            state.currentBet = Math.round(state.betLevel * state.unitSize);
            
            // Asegurar que la apuesta no sea mayor al saldo
            if (state.currentBet > state.balance) {
                state.currentBet = state.balance;
            }
            
            // Mínimo de apuesta: 1 unidad o 100, lo que sea mayor
            const minBet = Math.max(100, state.unitSize);
            if (state.currentBet < minBet) {
                state.currentBet = minBet;
            }
            
            return state.currentBet;
        }

        // ============================================
        // ACTUALIZACIÓN DE UI
        // ============================================
        function updateUI() {
            // Actualizar contadores
            document.getElementById('numbersEnteredCount').textContent = state.numbers.length;
            document.getElementById('totalSpins').textContent = state.history.length;
            
            // Actualizar barra de progreso de números
            const numbersProgress = Math.min(100, (state.numbers.length / 37) * 100);
            document.getElementById('numbersProgress').style.width = numbersProgress + '%';
            
            // Actualizar saldo y precisión
            document.getElementById('currentBalance').textContent = '$' + state.balance.toLocaleString();
            
            // Calcular precisión
            const totalTestSpins = state.testPhaseCount || 1;
            const accuracy = (state.testHits / totalTestSpins) * 100;
            document.getElementById('accuracy').textContent = accuracy.toFixed(1) + '%';
            
            // Actualizar fase
            updatePhaseDisplay();
            
            // Actualizar progreso hacia la meta
            updateProgressBar();
            
            // Actualizar predicciones
            updatePredictions();
            
            // Actualizar apuesta y fichas
            updateBetDisplay();
            
            // Actualizar historial
            updateHistory();
            
            // Actualizar estadísticas de docenas
            updateDozenStatsDisplay();
        }

        // Actualizar visualización de fase
        function updatePhaseDisplay() {
            const phaseNames = {
                1: 'Fase 1: Recolección',
                2: 'Fase 2: Calibración',
                3: 'Fase 3: Fuego Real',
                4: 'Fase 4: Protección'
            };
            
            const phaseColors = {
                1: 'text-red-400',
                2: 'text-yellow-400',
                3: 'text-green-400',
                4: 'text-orange-400'
            };
            
            const phaseElement = document.getElementById('currentPhase');
            phaseElement.textContent = phaseNames[state.phase];
            phaseElement.className = `text-xl font-bold ${phaseColors[state.phase]}`;
            
            // Actualizar mensaje de fase
            updatePhaseMessage(getPhaseMessage());
        }

        // Obtener mensaje según fase
        function getPhaseMessage() {
            switch(state.phase) {
                case 1:
                    return `Recolectando datos iniciales (${state.numbers.length}/37 números). Ingresa números para continuar.`;
                case 2:
                    const accuracy = (state.testHits / (state.testPhaseCount || 1)) * 100;
                    return `Calibrando sistema... Precisión actual: ${accuracy.toFixed(1)}% (${state.testHits}/${state.testPhaseCount} aciertos). Se necesita 75% para pasar a Fuego Real.`;
                case 3:
                    return `MODO ACTIVO - Apostando a la docena ${state.currentDozenPrediction}. Apuesta: $${state.currentBet.toLocaleString()}. Nivel D'Alembert: ${state.betLevel}.`;
                case 4:
                    return `MODO PROTECCIÓN - ${state.consecutiveLosses} pérdidas consecutivas. Volviendo a calibración...`;
                default:
                    return '';
            }
        }

        // Actualizar mensaje de fase en UI
        function updatePhaseMessage(message) {
            const phaseMessageElement = document.getElementById('phaseMessage');
            const phaseColors = {
                1: 'bg-blue-900/30 border-blue-700',
                2: 'bg-yellow-900/30 border-yellow-700',
                3: 'bg-green-900/30 border-green-700',
                4: 'bg-red-900/30 border-red-700'
            };
            
            phaseMessageElement.className = `mt-6 p-4 rounded-lg border ${phaseColors[state.phase]} fade-in`;
            phaseMessageElement.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-info-circle ${state.phase === 3 ? 'text-green-400' : state.phase === 4 ? 'text-red-400' : 'text-cyan-400'} mr-3 text-xl"></i>
                    <div>
                        <div class="font-bold ${state.phase === 3 ? 'text-green-400' : state.phase === 4 ? 'text-red-400' : 'text-cyan-400'}">${document.getElementById('currentPhase').textContent}</div>
                        <div class="text-gray-300">${message}</div>
                    </div>
                </div>
            `;
        }

        // Actualizar barra de progreso hacia la meta
        function updateProgressBar() {
            const progressFill = document.getElementById('progressFill');
            const currentProgress = document.getElementById('currentProgress');
            const targetProgress = document.getElementById('targetProgress');
            
            const start = state.initialBalance;
            const target = state.profitTarget;
            const current = state.balance;
            
            // Calcular progreso normalizado (0% a 100%)
            let progressPercent = 0;
            if (target > start) {
                progressPercent = ((current - start) / (target - start)) * 100;
            }
            
            // Limitar entre 0% y 100%
            progressPercent = Math.max(0, Math.min(100, progressPercent));
            
            progressFill.style.width = progressPercent + '%';
            currentProgress.textContent = '$' + current.toLocaleString();
            targetProgress.textContent = '$' + target.toLocaleString();
        }

        // Actualizar predicciones en UI
        function updatePredictions() {
            // Actualizar docena predicha
            const predictedDozenElement = document.getElementById('predictedDozen');
            if (state.phase >= 2 && state.currentDozenPrediction) {
                predictedDozenElement.textContent = `Docena ${state.currentDozenPrediction}`;
                predictedDozenElement.className = "text-4xl font-bold neon-cyan text-center py-4 pulse";
            } else {
                predictedDozenElement.textContent = "-";
                predictedDozenElement.className = "text-4xl font-bold text-gray-500 text-center py-4";
            }
            
            // Actualizar números recomendados
            const recommendedNumbersElement = document.getElementById('recommendedNumbers');
            if (state.currentDozenPrediction) {
                const startNumber = (state.currentDozenPrediction - 1) * 12 + 1;
                const endNumber = state.currentDozenPrediction * 12;
                const numbers = [];
                for (let i = startNumber; i <= endNumber; i++) {
                    numbers.push(i);
                }
                recommendedNumbersElement.textContent = numbers.join(', ');
                recommendedNumbersElement.className = "text-xl font-bold text-center py-4 text-green-400";
            } else {
                recommendedNumbersElement.textContent = "Esperando datos...";
                recommendedNumbersElement.className = "text-xl font-bold text-center py-4 text-gray-500";
            }
        }

        // Actualizar estadísticas de docenas en UI
        function updateDozenStatsDisplay() {
            // Encontrar docena caliente (más frecuente)
            let hotDozen = 1;
            let maxCount = state.dozenStats[1].count;
            for (let i = 2; i <= 3; i++) {
                if (state.dozenStats[i].count > maxCount) {
                    maxCount = state.dozenStats[i].count;
                    hotDozen = i;
                }
            }
            
            // Encontrar docena fría (menos frecuente)
            let coldDozen = 1;
            let minCount = state.dozenStats[1].count;
            for (let i = 2; i <= 3; i++) {
                if (state.dozenStats[i].count < minCount) {
                    minCount = state.dozenStats[i].count;
                    coldDozen = i;
                }
            }
            
            // Actualizar UI
            document.getElementById('hotDozen').textContent = `Docena ${hotDozen}`;
            document.getElementById('coldDozen').textContent = `Docena ${coldDozen}`;
            
            // Último acierto
            const lastHitElement = document.getElementById('lastHit');
            if (state.history.length > 0) {
                const lastHit = state.history.find(entry => entry.hit);
                if (lastHit) {
                    lastHitElement.textContent = `#${lastHit.number}`;
                } else {
                    lastHitElement.textContent = "Ninguno";
                }
            } else {
                lastHitElement.textContent = "-";
            }
        }

        // Actualizar visualización de apuesta y fichas
        function updateBetDisplay() {
            // Actualizar monto de apuesta
            const currentBetElement = document.getElementById('currentBet');
            if (state.phase >= 3) {
                currentBetElement.textContent = '$' + state.currentBet.toLocaleString();
                currentBetElement.className = "text-3xl font-bold neon-cyan text-center";
            } else {
                currentBetElement.textContent = 'Modo Prueba';
                currentBetElement.className = "text-3xl font-bold text-gray-500 text-center";
            }
            
            // Actualizar composición de fichas
            updateChipComposition();
        }

        // Actualizar composición de fichas
        function updateChipComposition() {
            const chipCompositionElement = document.getElementById('chipComposition');
            
            if (state.phase < 3 || state.currentBet <= 0) {
                chipCompositionElement.innerHTML = '<div class="text-gray-500 text-center py-4">Ingresa números para calcular la apuesta</div>';
                return;
            }
            
            // Calcular qué fichas usar para la apuesta actual
            let remaining = state.currentBet;
            const chipsUsed = [];
            
            // Ordenar fichas de mayor a menor valor
            const sortedChips = [...chipValues].sort((a, b) => b - a);
            
            for (const chipValue of sortedChips) {
                if (remaining >= chipValue) {
                    const count = Math.floor(remaining / chipValue);
                    for (let i = 0; i < count; i++) {
                        chipsUsed.push(chipValue);
                    }
                    remaining %= chipValue;
                }
            }
            
            // Si queda un resto, añadir una ficha más pequeña
            if (remaining > 0) {
                for (const chipValue of sortedChips.slice().reverse()) {
                    if (chipValue >= remaining) {
                        chipsUsed.push(chipValue);
                        break;
                    }
                }
            }
            
            // Generar HTML para las fichas
            if (chipsUsed.length === 0) {
                chipCompositionElement.innerHTML = '<div class="text-gray-500 text-center py-4">Apuesta demasiado pequeña para fichas disponibles</div>';
            } else {
                chipCompositionElement.innerHTML = '';
                chipsUsed.forEach(chipValue => {
                    const chipElement = document.createElement('div');
                    chipElement.className = `chip chip-${chipValue} chip-shadow`;
                    chipElement.textContent = chipValue >= 1000000 ? 
                        (chipValue / 1000000) + 'M' : 
                        chipValue >= 1000 ? 
                        (chipValue / 1000) + 'K' : 
                        chipValue;
                    chipElement.title = `$${chipValue.toLocaleString()}`;
                    chipCompositionElement.appendChild(chipElement);
                });
            }
        }

        // Actualizar historial en UI
        function updateHistory() {
            const historyBody = document.getElementById('historyBody');
            const totalHitsElement = document.getElementById('totalHits');
            const hitPercentageElement = document.getElementById('hitPercentage');
            
            if (state.history.length === 0) {
                historyBody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-500">No hay historial aún. Ingresa números para comenzar.</td></tr>';
                totalHitsElement.textContent = '0';
                hitPercentageElement.textContent = '0';
                return;
            }
            
            // Calcular estadísticas
            const totalHits = state.history.filter(entry => entry.hit).length;
            const hitPercentage = state.history.length > 0 ? ((totalHits / state.history.length) * 100).toFixed(1) : '0';
            
            totalHitsElement.textContent = totalHits;
            hitPercentageElement.textContent = hitPercentage;
            
            // Generar filas de historial (mostrar las últimas 20)
            const recentHistory = state.history.slice(0, 20);
            historyBody.innerHTML = '';
            
            recentHistory.forEach((entry, index) => {
                const row = document.createElement('tr');
                row.className = `history-item border-b border-gray-800 hover:bg-gray-800/50 ${index % 2 === 0 ? 'bg-gray-900/30' : ''}`;
                
                row.innerHTML = `
                    <td class="py-3">${state.history.length - index}</td>
                    <td class="py-3">
                        <span class="inline-block w-8 h-8 rounded-full text-center leading-8 font-bold ${entry.color}-roulette">
                            ${entry.number}
                        </span>
                    </td>
                    <td class="py-3">
                        <span class="capitalize">${entry.color}</span>
                    </td>
                    <td class="py-3">${entry.dozen > 0 ? 'Docena ' + entry.dozen : 'Cero'}</td>
                    <td class="py-3">${entry.prediction ? 'Docena ' + entry.prediction : '-'}</td>
                    <td class="py-3">
                        <span class="${entry.hit ? 'text-green-400' : 'text-red-400'} font-bold">
                            ${entry.hit ? '✓ ACIERTO' : '✗ FALLO'}
                        </span>
                    </td>
                    <td class="py-3">${entry.bet ? '$' + entry.bet.toLocaleString() : '-'}</td>
                    <td class="py-3 ${entry.balance >= state.initialBalance ? 'text-green-400' : 'text-red-400'}">
                        $${entry.balance.toLocaleString()}
                    </td>
                `;
                
                historyBody.appendChild(row);
            });
        }

        // ============================================
        // FUNCIONES DE CONTROL
        // ============================================

        // Actualizar configuración
        function updateSettings() {
            const initialCapital = parseInt(document.getElementById('initialCapital').value) || 10000;
            const profitTarget = parseInt(document.getElementById('profitTarget').value) || 15000;
            const stopLoss = parseInt(document.getElementById('stopLoss').value) || 5000;
            
            // Validar valores
            if (initialCapital < 100) {
                alert('El capital inicial debe ser al menos $100');
                return;
            }
            
            if (profitTarget <= initialCapital) {
                alert('La meta de ganancia debe ser mayor al capital inicial');
                return;
            }
            
            if (stopLoss >= initialCapital) {
                alert('El stop loss debe ser menor al capital inicial');
                return;
            }
            
            // Actualizar estado
            state.initialBalance = initialCapital;
            state.balance = initialCapital;
            state.profitTarget = profitTarget;
            state.stopLoss = stopLoss;
            
            // Reiniciar sistema si estaba en fase activa
            if (state.phase >= 3) {
                state.phase = 1;
                state.numbers = [];
                state.history = [];
                state.testPhaseCount = 0;
                state.testHits = 0;
                state.consecutiveLosses = 0;
                state.betLevel = 1;
                updatePhaseMessage("Configuración actualizada. Reiniciando a FASE 1: RECOLECCIÓN.");
            }
            
            // Guardar y actualizar
            saveState();
            updateUI();
            
            // Mostrar confirmación
            alert('Configuración actualizada correctamente');
        }

        // Cambiar crupier (reiniciar sistema)
        function changeDealer() {
            if (confirm('¿Cambiar de crupier? Esto reiniciará el historial y volverá a la Fase 1, pero mantendrá el saldo actual.')) {
                // Mantener saldo pero reiniciar todo lo demás
                const currentBalance = state.balance;
                
                // Reiniciar estado (excepto saldo)
                Object.assign(state, {
                    phase: 1,
                    currentBet: 0,
                    betLevel: 1,
                    numbers: [],
                    history: [],
                    predictions: [],
                    testPhaseCount: 0,
                    testHits: 0,
                    consecutiveLosses: 0,
                    dozenStats: {
                        1: {count: 0, lastSeen: 0},
                        2: {count: 0, lastSeen: 0},
                        3: {count: 0, lastSeen: 0}
                    },
                    unitSize: 0,
                    currentDozenPrediction: null,
                    balance: currentBalance
                });
                
                saveState();
                updateUI();
                updatePhaseMessage("¡Crupier cambiado! Sistema reiniciado. Comienza a ingresar números para la nueva sesión.");
            }
        }

        // Deshacer última jugada
        function undoLast() {
            if (state.numbers.length === 0) {
                alert('No hay números para deshacer');
                return;
            }
            
            // Eliminar último número
            const lastNumber = state.numbers.pop();
            
            // Actualizar estadísticas de docenas
            const dozen = numberToDozen(lastNumber);
            if (dozen > 0 && state.dozenStats[dozen].count > 0) {
                state.dozenStats[dozen].count--;
            }
            
            // Recalcular retrasos
            updateDozenStats();
            
            // Eliminar última entrada del historial si existe
            if (state.history.length > 0) {
                const lastEntry = state.history.shift();
                
                // Revertir cambios en saldo si estaba en fase activa
                if (state.phase >= 3 && lastEntry.bet) {
                    if (lastEntry.hit) {
                        // Revertir ganancia
                        state.balance -= lastEntry.bet * 2;
                        state.consecutiveLosses = Math.max(0, state.consecutiveLosses - 1);
                        state.betLevel = Math.min(state.betLevel + 1, 10); // Revertir D'Alembert
                    } else {
                        // Revertir pérdida
                        state.balance += lastEntry.bet;
                        state.consecutiveLosses = Math.max(0, state.consecutiveLosses - 1);
                        state.betLevel = Math.max(1, state.betLevel - 1); // Revertir D'Alembert
                    }
                }
            }
            
            // Si estaba en fase 2, revertir contadores de prueba
            if (state.phase === 2 && state.testPhaseCount > 0) {
                state.testPhaseCount--;
                // Nota: No podemos saber si era un acierto sin guardar más información
                // Por simplicidad, asumiremos que no era acierto
                state.testHits = Math.max(0, state.testHits - 0);
            }
            
            // Si después de deshacer tenemos menos de 37 números y estábamos en fase > 1, volver a fase 1
            if (state.numbers.length < 37 && state.phase > 1) {
                state.phase = 1;
            }
            
            saveState();
            updateUI();
            updatePhaseMessage("Último número deshecho. Números restantes: " + state.numbers.length);
        }

        // Exportar datos como JSON
        function exportData() {
            const exportObj = {
                metadata: {
                    app: "NEON ROULETTE MASTER V1",
                    exportDate: new Date().toISOString(),
                    phase: state.phase,
                    balance: state.balance,
                    initialBalance: state.initialBalance,
                    profitTarget: state.profitTarget,
                    stopLoss: state.stopLoss
                },
                statistics: {
                    totalSpins: state.numbers.length,
                    testAccuracy: (state.testHits / (state.testPhaseCount || 1)) * 100,
                    dozenStats: state.dozenStats,
                    recentHistory: state.history.slice(0, 50)
                },
                rawData: {
                    numbers: state.numbers,
                    fullHistory: state.history
                }
            };
            
            const dataStr = JSON.stringify(exportObj, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `neon-roulette-data-${new Date().toISOString().slice(0,10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            updatePhaseMessage("Datos exportados correctamente como " + exportFileDefaultName);
        }

        // Limpiar todo (reinicio completo)
        function clearAll() {
            if (confirm('¿Reiniciar completamente el sistema? Esto borrará todos los datos y restablecerá el saldo inicial.')) {
                // Restablecer estado completamente
                Object.assign(state, {
                    phase: 1,
                    balance: parseInt(document.getElementById('initialCapital').value) || 10000,
                    initialBalance: parseInt(document.getElementById('initialCapital').value) || 10000,
                    profitTarget: parseInt(document.getElementById('profitTarget').value) || 15000,
                    stopLoss: parseInt(document.getElementById('stopLoss').value) || 5000,
                    currentBet: 0,
                    betLevel: 1,
                    numbers: [],
                    history: [],
                    predictions: [],
                    testPhaseCount: 0,
                    testHits: 0,
                    consecutiveLosses: 0,
                    dozenStats: {
                        1: {count: 0, lastSeen: 0},
                        2: {count: 0, lastSeen: 0},
                        3: {count: 0, lastSeen: 0}
                    },
                    unitSize: 0,
                    currentDozenPrediction: null
                });
                
                saveState();
                updateUI();
                updatePhaseMessage("Sistema reiniciado completamente. Comienza a ingresar números.");
            }
        }

        // Simular número aleatorio
        function simulateRandom() {
            const randomNumber = Math.floor(Math.random() * 37); // 0-36
            addNumber(randomNumber);
            
            // Efecto visual en el botón del número
            const numberButtons = document.querySelectorAll('button[data-number]');
            numberButtons.forEach(button => {
                if (parseInt(button.dataset.number) === randomNumber) {
                    button.classList.add('neon-glow');
                    setTimeout(() => {
                        button.classList.remove('neon-glow');
                    }, 1000);
                }
            });
        }

        // Reiniciar a fase 1
        function resetToPhase1() {
            state.phase = 1;
            state.numbers = [];
            state.history = [];
            state.testPhaseCount = 0;
            state.testHits = 0;
            state.consecutiveLosses = 0;
            state.betLevel = 1;
            state.balance = state.initialBalance;
            
            saveState();
            updateUI();
        }

        // ============================================
        // INICIALIZACIÓN FINAL
        // ============================================
        // Asegurar que la UI esté actualizada
        window.addEventListener('beforeunload', saveState);
    </script>
</body>
</html>
